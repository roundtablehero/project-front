<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="UTF-8">
    <title>RPG</title>
    <script src=https://code.jquery.com/jquery-3.6.0.min.js></script>
    <link href="/css/my.css" rel="stylesheet">
</head>
<body>
<h1>RPG admin panel</h1>
<h2>Accounts List: </h2>

<div id="paging-panel-top">
    <label>
        Account per page:
        <select id="page-size-select">
            <option value="3">3</option>
            <option value="5">5</option>
            <option value="10">10</option>
            <option value="20">20</option>
        </select>
    </label>
</div>
<h1></h1>

<table id="main-table" class="myStyle">
    <thead>
        <tr>
            <th>#</th>
            <th>Name</th>
            <th>Title</th>
            <th>Race</th>
            <th>Profession</th>
            <th>Level</th>
            <th>Birthday</th>
            <th>Banned</th>
            <th>Edit</th>
            <th>Delete</th>
        </tr>
    </thead>
    <tbody>

    </tbody>
</table>

<script>
    let currentPage = 0;
    let pageSize = 3;
    let totalPlayers = 0;

    $(document).ready(function () {
        loadPlayers();
        loadPlayersCount();
    });

    $(document).on("click", ".save-icon", function () {
        let row = $(this).closest("tr");
        let playerId = $(this).data("id");

        savePlayer(playerId, row);
    });

    $(document).ready(function () {
        loadPlayers();
        loadPlayersCount();
        fillCreateSelects();
    });

    function savePlayer(playerId, row) {
        let updatedPlayer = {
            name: row.find("td").eq(1).find("input").val(),
            title: row.find("td").eq(2).find("input").val(),
            race: row.find("td").eq(3).find("select").val(),
            profession: row.find("td").eq(4).find("select").val(),
            banned: row.find("td").eq(7).find("select").val() === "true"
        };

        $.ajax({
            type: "POST",
            url: "/rest/players/" + playerId,
            contentType: "application/json",
            data: JSON.stringify(updatedPlayer),
            success: function () {
                loadPlayers();
                loadPlayersCount();
            },
            error: function () {
                alert("Ошибка при сохранении аккаунта");
            }
        });
    }



    $(document).on("click", ".delete-icon", function () {
        let playerId = $(this).data("id");
        deletePlayer(playerId);
    });

    function deletePlayer(playerId) {
        $.ajax({
            type: "DELETE",
            url: "/rest/players/" + playerId,
            success: function () {
                loadPlayers();
                loadPlayersCount();
            },
            error: function () {
                alert("Ошибка при удалении аккаунта");
            }
        });
    }

    $(document).on("click", ".edit-icon", function () {
        let row = $(this).closest("tr");
        enterEditMode(row);
    });

    function enterEditMode(row) {
        row.find(".delete-icon").hide();

        let editIcon = row.find(".edit-icon");
        editIcon.attr("src", "/img/save.png");
        editIcon.removeClass("edit-icon").addClass("save-icon");

        makeCellEditable(row, 1, 12); // Name
        makeCellEditable(row, 2, 30); // Title
        makeSelectEditable(row, 3, RACES);       // Race
        makeSelectEditable(row, 4, PROFESSIONS); // Profession
        makeBooleanSelect(row, 7); // Banned
    }

    function makeBooleanSelect(row, cellIndex) {
        let cell = row.find("td").eq(cellIndex);
        let currentValue = cell.text().trim() === "true";

        let select = $(`
        <select>
            <option value="false">false</option>
            <option value="true">true</option>
        </select>
    `);

        select.val(String(currentValue));
        cell.html(select);
    }


    function makeSelectEditable(row, cellIndex, values) {
        let cell = row.find("td").eq(cellIndex);
        let currentValue = cell.text().trim();


        let select = $("<select>");

        values.forEach(value => {
            let option = $("<option>")
                .val(value)
                .text(value);

            if (value === currentValue) {
                option.attr("selected", true);
            }

            select.append(option);
        });

        cell.html(select);
    }


    function makeCellEditable(row, cellIndex, maxLength) {
        let cell = row.find("td").eq(cellIndex);
        let value = cell.text();

        let maxAttr = maxLength ? `maxlength="${maxLength}"` : "";

        cell.html(`<input type="text" value="${value}" ${maxAttr}>`);
    }

    function loadPlayers() {
        $.ajax({
            type: "GET",
            url: "/rest/players",
            data: {
                pageNumber: currentPage,
                pageSize: pageSize
            },
            success: function (players) {
                fillTable(players);
            },
            error: function () {
                alert("Ошибка загрузки игроков");
            }
        });
    }

    function fillTable(players) {
        console.log(players);
        let tbody = $("#main-table tbody");
        tbody.empty();

        players.forEach((player, index) => {
            let row = `
                <tr>
                    <td>${player.id}</td>
                    <td>${player.name}</td>
                    <td>${player.title}</td>
                    <td>${player.race}</td>
                    <td>${player.profession}</td>
                    <td>${player.level}</td>
                    <td>${new Date(player.birthday).toLocaleDateString()}</td>
                    <td>${player.banned}</td>
                    <td>
                        <img src="/img/edit.png"
                             class="action-icon edit-icon"
                             data-id="${player.id}">
                    </td>

                    <td>
                        <img src="/img/delete.png"
                             class="action-icon delete-icon"
                             data-id="${player.id}">
                    </td>

                </tr>
            `;
            tbody.append(row);
        });
    }
    function loadPlayersCount() {
        $.ajax({
            type: "GET",
            url: "/rest/players/count",
            success: function (count) {
                totalPlayers = count;
                buildPaging();
            },
            error: function () {
                alert("Ошибка загрузки количества игроков");
            }
        });
    }

    $("#page-size-select").on("change", function () {
        pageSize = parseInt($(this).val());
        currentPage = 0; // возвращаемся на первую страницу
        loadPlayers();
        loadPlayersCount();
    });

    function buildPaging() {
        let pageButtons = $("#page-buttons-bottom");
        pageButtons.empty();

        let totalPages = Math.ceil(totalPlayers / pageSize);

        for (let i = 0; i < totalPages; i++) {
            let button = $("<button>")
                .text(i + 1)
                .addClass("page-button")
                .on("click", function () {
                    currentPage = i;
                    loadPlayers();
                    buildPaging();
                });

            if (i === currentPage) {
                button.attr("disabled", true);
                button.addClass("active");
            }

            pageButtons.append(button);
        }
    }

    const PROFESSIONS = [
        "WARRIOR",
        "ROGUE",
        "SORCERER",
        "CLERIC",
        "PALADIN",
        "NAZGUL",
        "WARLOCK",
        "DRUID"
    ];

    const RACES = [
        "HUMAN",
        "DWARF",
        "ELF",
        "GIANT",
        "ORC",
        "TROLL",
        "HOBBIT"
    ];

    function fillCreateSelects() {
        let raceSelect = $("#create-race");
        let professionSelect = $("#create-profession");

        raceSelect.empty();
        professionSelect.empty();

        RACES.forEach(race => {
            raceSelect.append(`<option value="${race}">${race}</option>`);
        });

        PROFESSIONS.forEach(profession => {
            professionSelect.append(`<option value="${profession}">${profession}</option>`);
        });
    }

    $(document).on("click", "#create-player-btn", function () {
        createPlayer();
    });

    function clearCreateForm() {
        $("#create-name").val("");
        $("#create-title").val("");
        $("#create-level").val(0);
        $("#create-birthday").val("");
        $("#create-banned").val("false");
    }

    function createPlayer() {
        let name = $("#create-name").val().trim();
        let title = $("#create-title").val().trim();
        let race = $("#create-race").val();
        let profession = $("#create-profession").val();
        let level = parseInt($("#create-level").val());
        let birthdayValue = $("#create-birthday").val();
        let banned = $("#create-banned").val() === "true";

        if (name.length === 0 || title.length === 0) {
            alert("Name and Title are required");
            return;
        }

        if (name.length < 1 || name.length > 12) {
            alert("Name must be from 1 to 12 characters");
            return;
        }

        if (!birthdayValue) {
            alert("Birthday is required");
            return;
        }

        let newPlayer = {
            name: name,
            title: title,
            race: race,
            profession: profession,
            level: level,
            birthday: new Date(birthdayValue).getTime(),
            banned: banned
        };

        $.ajax({
            type: "POST",
            url: "/rest/players",
            contentType: "application/json",
            data: JSON.stringify(newPlayer),
            success: function () {
                clearCreateForm();
                loadPlayers();
                loadPlayersCount();
            },
            error: function () {
                alert("Ошибка при создании аккаунта");
            }
        });
    }





</script>



<div id="paging-panel-bottom">

    <h1></h1>
    <span>Page: </span>
    <div id="page-buttons-bottom"></div>

</div>
<hr class="table-divider">

<h1>Create new account:</h1>

<div id="create-player-form">
    <label>Name:</label>
    <input type="text" id="create-name">

    <label>Title:</label>
    <input type="text" id="create-title">

    <label>Race:</label>
    <select id="create-race"></select>

    <label>Profession:</label>
    <select id="create-profession"></select>

    <label>Level:</label>
    <input type="number" id="create-level">

    <label>Birthday:</label>
    <input type="date" id="create-birthday">

    <label>Banned:</label>
    <select id="create-banned"></select>

    <div></div>
    <button id="create-player-btn">Create</button>
</div>

</body>
</html>